# JSNAPy test: Validate OSPF neighbors
# ------------------------------------------------------------
# What this test does
# - Runs "show ospf neighbor" on the device
# - Iterates over each OSPF neighbor in the XML
# - Verifies adjacency is Full and uptime is present/non-zero
#
# How to run
# - One-shot (snap + check in one step):
#     jsnapy --snapcheck -f tests/ospf_neighbors.yml -t devices.yml
# - Pre/Post (for change validation):
#     jsnapy --snap pre -f tests/ospf_neighbors.yml -t devices.yml
#     ...make your changes...
#     jsnapy --check post -f tests/ospf_neighbors.yml -t devices.yml
#
# Before you run
# - Verify element names on your device:
#     show ospf neighbor | display xml
#   Common elements include:
#     - neighbor-id
#     - interface-name
#     - ospf-neighbor-state
#     - neighbor-up-time
#
# Notes
# - If your platform reports uptime as 00:00:00 when down/reset, keep the non-zero check.
# - If the XML differs, adjust the element names accordingly.

tests:
  - name: ospf_neighbors
    command: "show ospf neighbor"

    iterate:
      # Iterate each neighbor entry that has a non-empty neighbor-id
      xpath: "//ospf-neighbor[normalize-space(neighbor-id)]"

      # Use neighbor-id as the identifier in messages
      id: "neighbor-id"

      tests:
        # 1) Neighbor must be Full
        - is-equal: [ospf-neighbor-state, Full]
          info: "Neighbor {{id}} adjacency is Full"
          err: "Neighbor {{id}} state is {{ospf-neighbor-state}} (expected: Full)"

        # 2) Uptime field must exist
        - exists: neighbor-up-time
          info: "Neighbor {{id}} has up-time: {{neighbor-up-time}}"
          err: "Neighbor {{id}} missing neighbor-up-time field"

        # 3) Uptime should be non-zero (common zero format is 00:00:00)
        - is-not-equal: [neighbor-up-time, "00:00:00"]
          info: "Neighbor {{id}} up-time is non-zero: {{neighbor-up-time}}"
          err: "Neighbor {{id}} up-time is zero (00:00:00)"

        # 4) Optional: Interface name should be present
        - exists: interface-name
          info: "Neighbor {{id}} is on interface {{interface-name}}"
          err: "Neighbor {{id}} missing interface-name"