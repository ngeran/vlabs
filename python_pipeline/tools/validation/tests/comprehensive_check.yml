# ==============================================================================
# JSNAPy Comprehensive Network Validation Test File (corrected)
# ==============================================================================

tests:
  - command: "show bgp summary"
    iterate:
      xpath: "//bgp-information/bgp-rib"
      id: "name"
      tests:
        - exists: "active-prefix-count"
          info: "BGP RIB <name>: <active-prefix-count> active prefixes"
          err: "BGP RIB <name>: active-prefix-count missing"
        - is-gt: ["received-prefix-count", 0]
          info: "BGP RIB <name>: received <received-prefix-count> prefixes"
          err: "BGP RIB <name>: no prefixes received"
        - is-gte: ["accepted-prefix-count", 0]
          info: "BGP RIB <name>: accepted <accepted-prefix-count> prefixes"
          err: "BGP RIB <name>: accepted-prefix-count invalid"
        - is-gte: ["suppressed-prefix-count", 0]
          info: "BGP RIB <name>: suppressed <suppressed-prefix-count> prefixes"
          err: "BGP RIB <name>: suppressed-prefix-count invalid"
        - is-gte: ["damped-prefix-count", 0]
          info: "BGP RIB <name>: <damped-prefix-count> damped prefixes"
          err: "BGP RIB <name>: damped-prefix-count missing"

  - command: "show bgp neighbor"
    iterate:
      xpath: "//bgp-information/bgp-peer"
      id: "peer-address"
      tests:
        - exists: "peer-as"
          info: "BGP peer <peer-address> AS <peer-as> discovered"
          err: "BGP peer <peer-address> AS number not found"
        - is-equal: ["peer-state", "Established"]
          info: "BGP peer <peer-address> AS <peer-as> is <peer-state>"
          err: "BGP peer <peer-address> is not Established (state=<peer-state>)"
        - is-lt: ["flap-count", 10]
          info: "BGP peer <peer-address> flap-count <flap-count> within threshold"
          err: "BGP peer <peer-address> flap-count excessive: <flap-count>"
        - exists: "peer-restart-time"
          info: "BGP peer <peer-address> last restart: <peer-restart-time>"
          err: "BGP peer <peer-address> restart time not available"
        - is-gte: ["nlri-type-peer", 1]
          info: "BGP peer <peer-address> supports <nlri-type-peer> NLRI types"
          err: "BGP peer <peer-address> NLRI support information missing"
        - no-diff: "flap-count"
          info: "BGP peer <peer-address> flap-count unchanged"
          err: "BGP peer <peer-address> flap-count changed from <pre[flap-count]> to <post[flap-count]>"

  - command: "show ldp neighbor"
    iterate:
      xpath: "//ldp-neighbor-information/ldp-neighbor"
      id: "ldp-neighbor-address"
      tests:
        - is-in: ["ldp-neighbor-state", ["Operational", "Up"]]
          info: "LDP neighbor <ldp-neighbor-address> state <ldp-neighbor-state>"
          err: "LDP neighbor <ldp-neighbor-address> bad state <ldp-neighbor-state>"
        - is-in: ["ldp-session-state", ["Operational", "Up", "Open"]]
          info: "LDP neighbor <ldp-neighbor-address> session <ldp-session-state>"
          err: "LDP neighbor <ldp-neighbor-address> session bad: <ldp-session-state>"
        - exists: "ldp-neighbor-address"
          info: "LDP neighbor address <ldp-neighbor-address> is valid"
          err: "LDP neighbor address missing or invalid"
        - is-gte: ["ldp-label-space-id", 0]
          info: "LDP neighbor <ldp-neighbor-address> label space ID: <ldp-label-space-id>"
          err: "LDP neighbor <ldp-neighbor-address> invalid label space ID"

  - command: "show rsvp session"
    iterate:
      xpath: "//rsvp-session-information/rsvp-session-data"
      id: "destination-address"
      tests:
        - is-in: ["session-state", ["Up", "Established"]]
          info: "RSVP <destination-address> state <session-state>"
          err: "RSVP <destination-address> not Up (state=<session-state>)"
        - exists: "name"
          info: "RSVP <destination-address> LSP <name>"
          err: "RSVP <destination-address> LSP name missing"
        - is-gte: ["lsp-bandwidth", 0]
          info: "RSVP LSP <name> bandwidth: <lsp-bandwidth> bps"
          err: "RSVP LSP <name> bandwidth information missing"
        - exists: "tunnel-id"
          info: "RSVP LSP <name> tunnel ID: <tunnel-id>"
          err: "RSVP LSP <name> tunnel ID missing"

  - command: "show mpls interface"
    iterate:
      xpath: "//mpls-interface-information/mpls-interface"
      id: "interface-name"
      tests:
        - exists: "interface-name"
          info: "MPLS interface <interface-name> present"
          err: "MPLS interface without name detected"
        - is-in: ["mpls-interface-state", ["Up", "Enabled"]]
          info: "MPLS interface <interface-name> state <mpls-interface-state>"
          err: "MPLS interface <interface-name> state bad: <mpls-interface-state>"
        - exists: "interface-index"
          info: "MPLS interface <interface-name> index: <interface-index>"
          err: "MPLS interface <interface-name> index missing"

  - command: "show interfaces descriptions"
    iterate:
      xpath: "//interface-information/physical-interface"
      id: "name"
      tests:
        - exists: "name"
          info: "Interface <name> detected"
          err: "Interface without name found"
        - exists: "admin-status"
          info: "Interface <name> admin-status: <admin-status>"
          err: "Interface <name> admin-status missing"
        - exists: "oper-status"
          info: "Interface <name> oper-status: <oper-status>"
          err: "Interface <name> oper-status missing"
        - no-diff: "description"
          info: "Interface <name> description unchanged: <description>"
          err: "Interface <name> description changed from '<pre[description]>' to '<post[description]>'"

  - command: "show interfaces terse"
    iterate:
      xpath: "//interface-information/physical-interface[admin-status='up']"
      id: "name"
      tests:
        - is-equal: ["oper-status", "up"]
          info: "Interface <name> is admin up and oper up"
          err: "Interface <name> is admin up but oper <oper-status>"
        - not-exists: "link-level-type[text()='Unspecified']"
          info: "Interface <name> has valid link-level-type"
          err: "Interface <name> has unspecified link-level-type"

  - command: "show system alarms"
    iterate:
      xpath: "//alarm-information/alarm-summary"
      id: "active-alarm-count"
      tests:
        - is-equal: ["active-alarm-count", 0]
          info: "No active system alarms (<active-alarm-count>)"
          err: "Active alarms present: <active-alarm-count>"

  - command: "show system alarms"
    iterate:
      xpath: "//alarm-information/alarm-detail"
      id: "alarm-time"
      tests:
        - exists: "alarm-time"
          info: "Alarm detected at <alarm-time>"
          err: "Alarm with missing timestamp"
        - exists: "alarm-class"
          info: "Alarm class: <alarm-class>"
          err: "Alarm class information missing"
        - exists: "alarm-description"
          info: "Alarm: <alarm-description>"
          err: "Alarm description missing"
        - is-not-in: ["alarm-class", ["Critical", "Major"]]
          info: "Alarm severity acceptable: <alarm-class>"
          err: "Critical/Major alarm detected: <alarm-class> - <alarm-description>"

  - command: "show route summary"
    iterate:
      xpath: "//route-summary-information/as-path-summary"
      id: "as-path-count"
      tests:
        - is-gt: ["as-path-count", 0]
          info: "AS path count: <as-path-count>"
          err: "No AS paths found in routing table"

  - command: "show route summary"
    iterate:
      xpath: "//route-summary-information/route-table"
      id: "table-name"
      tests:
        - exists: "table-name"
          info: "Route table <table-name> present"
          err: "Route table without name detected"
        - is-gte: ["destination-count", 0]
          info: "Route table <table-name> destinations: <destination-count>"
          err: "Route table <table-name> destination-count invalid"
        - is-gte: ["total-route-count", 0]
          info: "Route table <table-name> total routes: <total-route-count>"
          err: "Route table <table-name> total-route-count invalid"
        - is-gte: ["active-route-count", 0]
          info: "Route table <table-name> active routes: <active-route-count>"
          err: "Route table <table-name> active-route-count invalid"
        - is-gte: ["holddown-route-count", 0]
          info: "Route table <table-name> holddown routes: <holddown-route-count>"
          err: "Route table <table-name> holddown-route-count invalid"
        - is-gte: ["hidden-route-count", 0]
          info: "Route table <table-name> hidden routes: <hidden-route-count>"
          err: "Route table <table-name> hidden-route-count invalid"
        - no-diff: "active-route-count"
          info: "Route table <table-name> active routes unchanged (<active-route-count>)"
          err: "Route table <table-name> active routes changed from <pre[active-route-count]> to <post[active-route-count]>"

  - command: "show interfaces extensive"
    iterate:
      xpath: "//interface-information/physical-interface"
      id: "name"
      tests:
        - is-equal: ["input-error-list/input-errors", 0]
          info: "Interface <name> has no input errors"
          err: "Interface <name> input errors: <input-error-list/input-errors>"
        - is-equal: ["output-error-list/output-errors", 0]
          info: "Interface <name> has no output errors"
          err: "Interface <name> output errors: <output-error-list/output-errors>"
        - is-equal: ["input-error-list/input-drops", 0]
          info: "Interface <name> has no input drops"
          err: "Interface <name> input drops: <input-error-list/input-drops>"
        - is-equal: ["output-error-list/output-drops", 0]
          info: "Interface <name> has no output drops"
          err: "Interface <name> output drops: <output-error-list/output-drops>"

  - command: "show chassis environment"
    iterate:
      xpath: "//environment-information/environment-item"
      id: "name"
      tests:
        - is-in: ["status", ["OK", "Testing", "Online"]]
          info: "Environment component <name> status: <status>"
          err: "Environment component <name> status bad: <status>"
        - exists: "temperature"
          info: "Environment component <name> temperature: <temperature>C"
          err: "Environment component <name> temperature reading missing"

  - command: "show ospf neighbor"
    iterate:
      xpath: "//ospf-neighbor-information/ospf-neighbor"
      id: "neighbor-id"
      tests:
        - is-equal: ["ospf-neighbor-state", "Full"]
          info: "OSPF neighbor <neighbor-id> state: <ospf-neighbor-state>"
          err: "OSPF neighbor <neighbor-id> not Full (state=<ospf-neighbor-state>)"
        - exists: "interface-name"
          info: "OSPF neighbor <neighbor-id> via interface <interface-name>"
          err: "OSPF neighbor <neighbor-id> interface information missing"
        - is-gte: ["neighbor-priority", 0]
          info: "OSPF neighbor <neighbor-id> priority: <neighbor-priority>"
          err: "OSPF neighbor <neighbor-id> priority invalid"

  - command: "show system storage"
    iterate:
      xpath: "//system-storage-information/filesystem"
      id: "filesystem-name"
      tests:
        - is-lt: ["used-percent", 85]
          info: "Filesystem <filesystem-name> usage: <used-percent>%"
          err: "Filesystem <filesystem-name> usage high: <used-percent>%"
        - exists: "total-blocks"
          info: "Filesystem <filesystem-name> size: <total-blocks> blocks"
          err: "Filesystem <filesystem-name> size information missing"

  - command: "show system processes extensive"
    iterate:
      xpath: "//task-information/task-entry[command='rpd' or command='chassisd' or command='dcd']"
      id: "command"
      tests:
        - exists: "command"
          info: "Critical process <command> is running"
          err: "Critical process missing from process list"
        - is-lt: ["cpu-percent", 90]
          info: "Process <command> CPU usage: <cpu-percent>%"
          err: "Process <command> high CPU usage: <cpu-percent>%"